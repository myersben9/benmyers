{% extends 'user_portal_base.html' %}

{% block portal_content %}
<div id="upload-container" class="relative flex-grow h-full w-full overflow-hidden bg-cover bg-center">
    
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline">{{ error }}</span>
    </div>
    {% endif %}
    
    {% if success %}
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
        <strong class="font-bold">Success:</strong>
        <span class="block sm:inline">{{ success }}</span>
    </div>
    {% endif %}
    
    <!-- Main Content -->
    <div class="relative z-10 flex flex-col justify-center items-center h-full text-center mt-8 mb-8">
        <h1 class="text-5xl text-white-800 mb-6 leading-relaxed max-w-xl animate-slide-in">
            Upload Your Images
        </h1>

        <!-- Collage Container -->
        <div id="collage" class="grid gap-4 mt-6 w-full max-w-4xl animate-slide-in">
            <!-- Drag and Drop Squares -->
            <div class="dropzone bg-white bg-opacity-10 p-6 rounded shadow-lg border-dashed border-2 border-gray-400 cursor-pointer flex justify-center items-center aspect-square">
                <p class="text-lg text-white-700">Drag & drop or click to upload</p>
                <input type="file" class="hidden" multiple />
            </div>
        </div>

        <!-- Create Collage Button -->
        <button id="createCollageButton" class="mt-4 bg-green-500 text-white px-4 py-2 rounded animate-slide-in">
            Create Collage
        </button>
    </div>
</div>

<style>
    /* Styles for the collage grid */
    #collage {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Minimum 2x2 grid */
    }

    @media (min-width: 768px) {
        #collage {
            grid-template-columns: repeat(3, 1fr); /* 3x3 grid for tablet */
        }
    }

    @media (min-width: 1024px) {
        #collage {
            grid-template-columns: repeat(4, 1fr); /* 4x4 grid for desktop */
        }
    }

    .dropzone {
        position: relative;
        overflow: hidden;
        width: 100%;
    }

    .dropzone img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .aspect-square {
        aspect-ratio: 1 / 1;
    }
</style>

<script>
    const collage = document.getElementById('collage');
    const createCollageButton = document.getElementById('createCollageButton');
    let images = [];

    const dropzone = document.querySelector('.dropzone');
    initializeDropzone(dropzone);

    createCollageButton.addEventListener('click', () => {
        const filledImages = images.filter(img => img !== null);

        if (filledImages.length >= 4) {
            // Store the image URLs in localStorage
            localStorage.setItem('collageImageUrls', JSON.stringify(filledImages));

            // Redirect to the collage preview page
            window.location.href = '{{ url_for("collage_preview") }}';
        } else {
            alert('Please upload at least 4 images to create a collage.');
        }
    });

    function initializeDropzone(dropzone) {
        const input = dropzone.querySelector('input');

        dropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropzone.classList.add('bg-gray-200');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('bg-gray-200');
        });

        dropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropzone.classList.remove('bg-gray-200');
            const files = event.dataTransfer.files;
            handleFiles(files, dropzone);
        });

        dropzone.addEventListener('click', () => {
            input.click();
        });

        input.addEventListener('change', (event) => {
            const files = event.target.files;
            handleFiles(files, dropzone);
        });
    }

    async function handleFiles(files, dropzone) {
        for (let file of files) {
            const formData = new FormData();
            formData.append('file', file);

            // Upload the image to the server
            const response = await fetch('/upload-image/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (response.ok) {
                const imgElement = document.createElement('img');
                imgElement.src = `/static/${data.filename}`;
                dropzone.innerHTML = ''; // Clear existing content
                dropzone.appendChild(imgElement);

                // Store the image URL in the images array
                images.push(`/static/${data.filename}`);
            } else {
                alert('Failed to upload image.');
            }
        }
    }
</script>
{% endblock %}
